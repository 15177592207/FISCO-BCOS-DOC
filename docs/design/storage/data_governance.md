# 数据治理

随着业务量的增长，链上数据占用硬盘存储越来越大，同时节点的处理能力出现一定程度的衰减。为让业务方有良好的使用体验，我们从节点存储和外部存储两方面考虑，引入数据治理方案。该方案有如下目标：

1. 节点存储通过控制本地存储的数据量，进而稳定联机交易性能；
2. 外部存储通过导出节点数据，实现对历史数据的记录及容量的平行扩展。

上述目标的实现，在fisco bcos节点层面，涉及到以下核心机制：

- binlog机制
- scalable存储模式
- 快照机制

## 数据导出实现————binlog机制

binlog机制为外部存储提供区块维度的数据操作记录。binlog机制开启后，链上数据在写入缓存/落盘之前先写binlog。

![](../../../images/storage/storage_architecture.png)

binlog对区块数据以TLV的方式进行编码后写入文件，编码的字段内容及其长度如下图描述：

![](../../../images/storage/binlog_TLV.png)

- `_id_`等黑色字段，整形，字段上方表示其占用字节数；
- `tableName`等蓝色字段，字符串，字节占用数按字段串实际长度计算；
- `entries`等黄色字段，对象数组，前一count字段记录对象个数；
- 大小端标记统一用网络序（大端模式）；
- `version`用于版本控制;
- `CRC32`计算的内容为`_num_`、`dataCount`和`datas`；
- `blockLength`为`_num_`、`dataCount`、`datas`和`CRC32`的长度总和;
- binlog文件长度不大于128M。

外部存储目前支持mysql数据库，将基于拉取的binlog文件对节点数据进行还原并归档存储，同时新增了对节点数据的变动记录。以下图存储的区块链系统配置为例，从`_sys_config_d_`可知，tx_count_limit在块高2和3更新，tx_gas_limit在块高5更新，而两者的最新值分别为15000和500000000。

```sql
select * from _sys_config_;
+------+--------+----------+-------+----------------+-----------+------------+
| _id_ | _hash_ | _status_ | _num_ | key            | value     | enable_num |
+------+--------+----------+-------+----------------+-----------+------------+
|    2 | 0x00   |        0 |     3 | tx_count_limit | 15000     | 3          |
|    3 | 0x00   |        0 |     5 | tx_gas_limit   | 500000000 | 5          |
+------+--------+----------+-------+----------------+-----------+------------+
2 rows in set (0.02 sec)

select * from _sys_config_d_;
+-------+------+--------+----------+-------+----------------+-----------+------------+
| pk_id | _id_ | _hash_ | _status_ | _num_ | key            | value     | enable_num |
+-------+------+--------+----------+-------+----------------+-----------+------------+
|     1 |    2 | 0x00   |        0 |     0 | tx_count_limit | 1000      | 0          |
|     2 |    3 | 0x00   |        0 |     0 | tx_gas_limit   | 300000000 | 0          |
|     3 |    2 | 0x00   |        0 |     2 | tx_count_limit | 10000     | 2          |
|     4 |    2 | 0x00   |        0 |     3 | tx_count_limit | 15000     | 3          |
|     5 |    3 | 0x00   |        0 |     5 | tx_gas_limit   | 500000000 | 5          |
+-------+------+--------+----------+-------+----------------+-----------+------------+
5 rows in set (0.02 sec)
```

## 本地数据管理————scalable存储模式

为控制本地存储的整体数据量，数据治理方案在实现将数据通过binlog机制同步到外部存储进行归档的操作后，对本地相关数据进行裁剪。为支持对本地数据的裁剪操作，本方案在原有存储模式上新增scalable存储模式，对本地数据分实例存储。

在scalable模式下，节点的区块数据和状态数据存储在本地多个rocksdb数据库，同时需配置数据代理访问外部存储的mysql数据库，用于查询本地已裁剪的区块数据。

![](../../../images/storage/scalable.png)

**archive Storage**

- 该Storage持有一个或多个数据库，管理`_sys_hash_2_block_`和`_sys_block_2_nonces_`两个表的数据存储；
- 当节点重启或块高达到配置阈值时，Storage将进行切分新数据库；Storage所存储的数据将按该数据落盘时的块高确定其位于哪个数据库；
- 该Storage数据可删除，但删除操作的对象为整个数据库而非数据库中的部分key。

**state Storage**

- 该Storage通过一个数据库存储链上除`_sys_hash_2_block_`和`_sys_block_2_nonces_`两个表外其他表的数据。

**remote Storage**

- 该Storage存储对节点数据进行归档存储，通过数据代理进行访问，可用于查询本地已裁剪的区块数据。
- 节点启动时，将根据archive Storage数据的裁剪情况确定一阈值；后续对来自上层的查询请求，将基于查询传入的块高和前述阈值，判断访问本地的archive Storage还是访问远端remote Storage。

## 快速恢复数据————快照机制

外部存储的数据除了提供节点本地已裁剪数据的查询支持外，还可以提供特定区块高度下的快照信息，用于新节点通过拉取快照信息实现对链上数据的快速同步。

![](../../../images/storage/fast_sync.png)

1. 节点通过配置数据代理访问外部存储拉取特定高度下的快照信息，存于rocksdb数据库或者mysql数据库；
2. 节点基于快照信息同步后续的1000个区块，通过重放上述区块中的交易起到一定的验证作用。